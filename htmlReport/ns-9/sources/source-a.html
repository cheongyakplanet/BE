


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > UserService</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.cheonyakplanet.be.application.service</a>
</div>

<h1>Coverage Summary for Class: UserService (org.cheonyakplanet.be.application.service)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">UserService</td>
<td class="coverageStat">
  <span class="percent">
    9.5%
  </span>
  <span class="absValue">
    (2/21)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/40)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    1.5%
  </span>
  <span class="absValue">
    (3/198)
  </span>
</td>
</tr>
  <tr>
    <td class="name">UserService$$SpringCGLIB$$0</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    9.5%
  </span>
  <span class="absValue">
    (2/21)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/40)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    1.5%
  </span>
  <span class="absValue">
    (3/198)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package org.cheonyakplanet.be.application.service;
&nbsp;
&nbsp;import java.net.URI;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.Objects;
&nbsp;import java.util.Optional;
&nbsp;import java.util.Random;
&nbsp;import java.util.UUID;
&nbsp;import java.util.function.Consumer;
&nbsp;import java.util.stream.Collectors;
&nbsp;import java.util.stream.Stream;
&nbsp;
&nbsp;import org.cheonyakplanet.be.application.dto.ApiResponse;
&nbsp;import org.cheonyakplanet.be.application.dto.user.InterestLocationDTO;
&nbsp;import org.cheonyakplanet.be.application.dto.user.KakaoUserInfoDto;
&nbsp;import org.cheonyakplanet.be.application.dto.user.LoginRequestDTO;
&nbsp;import org.cheonyakplanet.be.application.dto.user.MyPageDTO;
&nbsp;import org.cheonyakplanet.be.application.dto.user.SignupRequestDTO;
&nbsp;import org.cheonyakplanet.be.application.dto.user.TokenResponse;
&nbsp;import org.cheonyakplanet.be.application.dto.user.UserDTO;
&nbsp;import org.cheonyakplanet.be.application.dto.user.UserUpdateRequestDTO;
&nbsp;import org.cheonyakplanet.be.application.dto.user.UserUpdateResponseDTO;
&nbsp;import org.cheonyakplanet.be.domain.entity.user.User;
&nbsp;import org.cheonyakplanet.be.domain.entity.user.UserRoleEnum;
&nbsp;import org.cheonyakplanet.be.domain.entity.user.UserToken;
&nbsp;import org.cheonyakplanet.be.domain.repository.PostRepository;
&nbsp;import org.cheonyakplanet.be.domain.repository.UserRepository;
&nbsp;import org.cheonyakplanet.be.domain.repository.UserTokenRepository;
&nbsp;import org.cheonyakplanet.be.infrastructure.jwt.JwtUtil;
&nbsp;import org.cheonyakplanet.be.infrastructure.security.UserDetailsImpl;
&nbsp;import org.cheonyakplanet.be.presentation.exception.CustomException;
&nbsp;import org.cheonyakplanet.be.presentation.exception.ErrorCode;
&nbsp;import org.springframework.http.HttpHeaders;
&nbsp;import org.springframework.http.RequestEntity;
&nbsp;import org.springframework.http.ResponseEntity;
&nbsp;import org.springframework.security.authentication.AuthenticationManager;
&nbsp;import org.springframework.security.authentication.DisabledException;
&nbsp;import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
&nbsp;import org.springframework.security.core.Authentication;
&nbsp;import org.springframework.security.crypto.password.PasswordEncoder;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import org.springframework.transaction.annotation.Transactional;
&nbsp;import org.springframework.util.LinkedMultiValueMap;
&nbsp;import org.springframework.util.MultiValueMap;
&nbsp;import org.springframework.util.StringUtils;
&nbsp;import org.springframework.web.client.RestTemplate;
&nbsp;import org.springframework.web.util.UriComponentsBuilder;
&nbsp;
&nbsp;import com.fasterxml.jackson.core.JsonProcessingException;
&nbsp;import com.fasterxml.jackson.databind.JsonNode;
&nbsp;import com.fasterxml.jackson.databind.ObjectMapper;
&nbsp;
&nbsp;import jakarta.servlet.http.HttpServletRequest;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;
<b class="fc">&nbsp;@Slf4j(topic = &quot;회원 가입 및 로그인&quot;)</b>
&nbsp;@Service
<b class="fc">&nbsp;@RequiredArgsConstructor</b>
&nbsp;public class UserService {
&nbsp;
&nbsp;	private final UserRepository userRepository;
&nbsp;	private final UserTokenRepository userTokenRepository;
&nbsp;	private final PasswordEncoder passwordEncoder;
&nbsp;	private final AuthenticationManager authenticationManager;
&nbsp;	private final RestTemplate restTemplate;
&nbsp;	private final JwtUtil jwtUtil;
&nbsp;	private final EmailService emailService;
&nbsp;	private final TokenCacheService tokenCacheService;
&nbsp;	private final PostRepository postRepository;
&nbsp;
&nbsp;
<b class="fc">&nbsp;	private final String ADMIN_TOKEN = &quot;AAABnvxRVklrnYxKZ0aHgTBcXukeZygoC&quot;;</b>
&nbsp;
&nbsp;	/**
&nbsp;	 * 회원가입
&nbsp;	 *
&nbsp;	 * @param requestDTO
&nbsp;	 */
&nbsp;	public void signup(SignupRequestDTO requestDTO) {
<b class="nc">&nbsp;		String useremail = requestDTO.getEmail();</b>
<b class="nc">&nbsp;		String password = passwordEncoder.encode(requestDTO.getPassword());</b>
<b class="nc">&nbsp;		String username = requestDTO.getUsername();</b>
&nbsp;
&nbsp;		// 중복 확인
<b class="nc">&nbsp;		if (userRepository.findByEmail(useremail).isPresent()) {</b>
<b class="nc">&nbsp;			throw new CustomException(ErrorCode.SIGN002, &quot;중복된 이메일 존재&quot;);</b>
&nbsp;		}
&nbsp;
&nbsp;		//  사용자 role 확인
<b class="nc">&nbsp;		UserRoleEnum role = UserRoleEnum.USER;</b>
<b class="nc">&nbsp;		if (requestDTO.isAdmin()) {</b>
<b class="nc">&nbsp;			if (!ADMIN_TOKEN.equals(requestDTO.getAdminToken())) {</b>
<b class="nc">&nbsp;				throw new CustomException(ErrorCode.SIGN003, &quot;관리자 가입 토큰 불일치&quot;);</b>
&nbsp;			}
<b class="nc">&nbsp;			role = UserRoleEnum.ADMIN;</b>
&nbsp;		}
&nbsp;
&nbsp;		// 사용자 등록
<b class="nc">&nbsp;		User user = new User(useremail, password, role, username);</b>
<b class="nc">&nbsp;		userRepository.save(user);</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * 로그인
&nbsp;	 *
&nbsp;	 * @param requestDTO
&nbsp;	 * @return
&nbsp;	 */
&nbsp;	public Object login(LoginRequestDTO requestDTO) {
&nbsp;		try {
&nbsp;			// 1) Spring Security AuthenticationManager 로 인증 시도
<b class="nc">&nbsp;			Authentication authentication = authenticationManager.authenticate(</b>
&nbsp;				new UsernamePasswordAuthenticationToken(
<b class="nc">&nbsp;					requestDTO.getEmail(),</b>
<b class="nc">&nbsp;					requestDTO.getPassword()</b>
&nbsp;				)
&nbsp;			);
&nbsp;
&nbsp;			// 2) 인증 성공 시 JWT 생성
<b class="nc">&nbsp;			UserDetailsImpl principal = (UserDetailsImpl)authentication.getPrincipal();</b>
<b class="nc">&nbsp;			UserRoleEnum role = principal.getUser().getRole();</b>
<b class="nc">&nbsp;			String accessToken = jwtUtil.createAccessToken(principal.getUsername(), role);</b>
<b class="nc">&nbsp;			String refreshToken = jwtUtil.createRefreshToken(principal.getUsername(), principal.getUser().getRole());</b>
<b class="nc">&nbsp;			jwtUtil.storeTokens(principal.getUsername(), accessToken, refreshToken);</b>
&nbsp;
<b class="nc">&nbsp;			return Map.of(</b>
&nbsp;				&quot;accessToken&quot;, accessToken,
&nbsp;				&quot;refreshToken&quot;, refreshToken
&nbsp;			);
<b class="nc">&nbsp;		} catch (DisabledException e) {</b>
<b class="nc">&nbsp;			log.info(&quot;탈퇴한 회원 로그인 시도: {}&quot;, e.getMessage());</b>
<b class="nc">&nbsp;			throw new CustomException(ErrorCode.SIGN006, &quot;탈퇴한 회원입니다.&quot;);</b>
<b class="nc">&nbsp;		} catch (Exception e) {</b>
<b class="nc">&nbsp;			log.info(e.getMessage());</b>
<b class="nc">&nbsp;			log.error(&quot;Authentication failed&quot;, e);</b>
<b class="nc">&nbsp;			throw new CustomException(ErrorCode.SIGN004, &quot;로그인 정보 불일치&quot;);</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	public Object logout(HttpServletRequest request) {
&nbsp;
<b class="nc">&nbsp;		String token = jwtUtil.getTokenFromRequest(request);</b>
<b class="nc">&nbsp;		if (!StringUtils.hasText(token)) {</b>
<b class="nc">&nbsp;			throw new CustomException(ErrorCode.AUTH001, &quot;토큰이 존재하지 않습니다.&quot;);</b>
&nbsp;		}
&nbsp;
<b class="nc">&nbsp;		Optional&lt;UserToken&gt; tokenEntityOpt = userTokenRepository.findByAccessToken(JwtUtil.BEARER_PREFIX + token);</b>
<b class="nc">&nbsp;		if (tokenEntityOpt.isPresent()) {</b>
<b class="nc">&nbsp;			UserToken userToken = tokenEntityOpt.get();</b>
<b class="nc">&nbsp;			userToken.blacklist(); // 토큰을 블랙리스트에 등록</b>
<b class="nc">&nbsp;			userTokenRepository.save(userToken);</b>
<b class="nc">&nbsp;			return &quot;로그아웃 성공&quot;;</b>
&nbsp;		} else {
<b class="nc">&nbsp;			throw new CustomException(ErrorCode.AUTH002, &quot;토큰 정보가 존재하지 않습니다.&quot;);</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	public String kakaoLogin(String code) throws JsonProcessingException {
&nbsp;		// 1. &quot;인가 코드&quot;로 &quot;액세스 토큰&quot; 요청
<b class="nc">&nbsp;		String kakaoAccessToken = getToken(code);</b>
&nbsp;
&nbsp;		// 2. 토큰으로 카카오 API 호출 : &quot;액세스 토큰&quot;으로 &quot;카카오 사용자 정보&quot; 가져오기
<b class="nc">&nbsp;		KakaoUserInfoDto kakaoUserInfo = getKakaoUserInfo(kakaoAccessToken);</b>
&nbsp;
&nbsp;		// 3. 이메일로 사용자 조회, 없으면 신규 가입
<b class="nc">&nbsp;		String email = kakaoUserInfo.getEmail();</b>
<b class="nc">&nbsp;		User user = userRepository.findByEmailAndDeletedAtIsNull(email)</b>
<b class="nc">&nbsp;			.orElseGet(() -&gt; {</b>
&nbsp;				// 신규 사용자 생성
<b class="nc">&nbsp;				String rawPassword = String.valueOf(kakaoUserInfo.getId());</b>
<b class="nc">&nbsp;				String encodedPassword = passwordEncoder.encode(rawPassword);</b>
<b class="nc">&nbsp;				String nickname = kakaoUserInfo.getNickname();</b>
<b class="nc">&nbsp;				User newUser = new User(email, encodedPassword, UserRoleEnum.USER, nickname);</b>
<b class="nc">&nbsp;				return userRepository.save(newUser);</b>
&nbsp;			});
&nbsp;
&nbsp;		// 4) 토큰 생성
<b class="nc">&nbsp;		String accessToken = jwtUtil.createAccessToken(user.getEmail(), user.getRole());</b>
<b class="nc">&nbsp;		String refreshToken = jwtUtil.createRefreshToken(user.getEmail(), user.getRole());</b>
<b class="nc">&nbsp;		jwtUtil.storeTokens(user.getEmail(), accessToken, refreshToken);</b>
&nbsp;
<b class="nc">&nbsp;		TokenResponse tokens = new TokenResponse(accessToken, refreshToken);</b>
&nbsp;
&nbsp;		// 임시 코드 생성
<b class="nc">&nbsp;		String stateCode = UUID.randomUUID().toString().substring(0, 8);</b>
&nbsp;
&nbsp;		// 인메모리 캐시에 임시 저장 (5분 만료)
<b class="nc">&nbsp;		tokenCacheService.storeTokens(stateCode, tokens, 300);</b>
&nbsp;
<b class="nc">&nbsp;		return stateCode;</b>
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;	private String getToken(String code) throws JsonProcessingException {
&nbsp;		// 요청 URL 만들기
<b class="nc">&nbsp;		URI uri = UriComponentsBuilder</b>
<b class="nc">&nbsp;			.fromUriString(&quot;https://kauth.kakao.com&quot;)</b>
<b class="nc">&nbsp;			.path(&quot;/oauth/token&quot;)</b>
<b class="nc">&nbsp;			.encode()</b>
<b class="nc">&nbsp;			.build()</b>
<b class="nc">&nbsp;			.toUri();</b>
&nbsp;
&nbsp;		// HTTP Header 생성
<b class="nc">&nbsp;		HttpHeaders headers = new HttpHeaders();</b>
<b class="nc">&nbsp;		headers.add(&quot;Content-type&quot;, &quot;application/x-www-form-urlencoded;charset=utf-8&quot;);</b>
&nbsp;
&nbsp;		// HTTP Body 생성
<b class="nc">&nbsp;		MultiValueMap&lt;String, String&gt; body = new LinkedMultiValueMap&lt;&gt;();</b>
<b class="nc">&nbsp;		body.add(&quot;grant_type&quot;, &quot;authorization_code&quot;);</b>
<b class="nc">&nbsp;		body.add(&quot;client_id&quot;, &quot;b3ffa0766c60125572ebdc645fceb9c6&quot;);</b>
<b class="nc">&nbsp;		body.add(&quot;redirect_uri&quot;, &quot;http://run.blu2print.site:8082/api/member/kakao/callback&quot;);</b>
<b class="nc">&nbsp;		body.add(&quot;code&quot;, code);</b>
&nbsp;
<b class="nc">&nbsp;		RequestEntity&lt;MultiValueMap&lt;String, String&gt;&gt; requestEntity = RequestEntity</b>
<b class="nc">&nbsp;			.post(uri)</b>
<b class="nc">&nbsp;			.headers(headers)</b>
<b class="nc">&nbsp;			.body(body);</b>
&nbsp;
&nbsp;		// HTTP 요청 보내기
<b class="nc">&nbsp;		ResponseEntity&lt;String&gt; response = restTemplate.exchange(</b>
&nbsp;			requestEntity,
&nbsp;			String.class
&nbsp;		);
&nbsp;
&nbsp;		// HTTP 응답 (JSON) -&gt; 액세스 토큰 파싱
<b class="nc">&nbsp;		JsonNode jsonNode = new ObjectMapper().readTree(response.getBody());</b>
<b class="nc">&nbsp;		return jsonNode.get(&quot;access_token&quot;).asText();</b>
&nbsp;	}
&nbsp;
&nbsp;	private KakaoUserInfoDto getKakaoUserInfo(String accessToken) throws JsonProcessingException {
&nbsp;		// 요청 URL 만들기
<b class="nc">&nbsp;		URI uri = UriComponentsBuilder</b>
<b class="nc">&nbsp;			.fromUriString(&quot;https://kapi.kakao.com&quot;)</b>
<b class="nc">&nbsp;			.path(&quot;/v2/user/me&quot;)</b>
<b class="nc">&nbsp;			.encode()</b>
<b class="nc">&nbsp;			.build()</b>
<b class="nc">&nbsp;			.toUri();</b>
&nbsp;
&nbsp;		// HTTP Header 생성
<b class="nc">&nbsp;		HttpHeaders headers = new HttpHeaders();</b>
<b class="nc">&nbsp;		headers.add(&quot;Authorization&quot;, &quot;Bearer &quot; + accessToken);</b>
<b class="nc">&nbsp;		headers.add(&quot;Content-type&quot;, &quot;application/x-www-form-urlencoded;charset=utf-8&quot;);</b>
&nbsp;
<b class="nc">&nbsp;		RequestEntity&lt;MultiValueMap&lt;String, String&gt;&gt; requestEntity = RequestEntity</b>
<b class="nc">&nbsp;			.post(uri)</b>
<b class="nc">&nbsp;			.headers(headers)</b>
<b class="nc">&nbsp;			.body(new LinkedMultiValueMap&lt;&gt;());</b>
&nbsp;
&nbsp;		// HTTP 요청 보내기
<b class="nc">&nbsp;		ResponseEntity&lt;String&gt; response = restTemplate.exchange(</b>
&nbsp;			requestEntity,
&nbsp;			String.class
&nbsp;		);
&nbsp;
<b class="nc">&nbsp;		JsonNode jsonNode = new ObjectMapper().readTree(response.getBody());</b>
<b class="nc">&nbsp;		Long id = jsonNode.get(&quot;id&quot;).asLong();</b>
<b class="nc">&nbsp;		String nickname = jsonNode.get(&quot;properties&quot;)</b>
<b class="nc">&nbsp;			.get(&quot;nickname&quot;).asText();</b>
<b class="nc">&nbsp;		String email = jsonNode.get(&quot;kakao_account&quot;)</b>
<b class="nc">&nbsp;			.get(&quot;email&quot;).asText();</b>
&nbsp;
<b class="nc">&nbsp;		log.info(&quot;카카오 사용자 정보: &quot; + id + &quot;, &quot; + nickname + &quot;, &quot; + email);</b>
<b class="nc">&nbsp;		return new KakaoUserInfoDto(id, nickname, email);</b>
&nbsp;	}
&nbsp;
&nbsp;	public Object refreshAccessToken(String refreshToken) {
<b class="nc">&nbsp;		String pureToken = jwtUtil.substringToken(refreshToken);</b>
&nbsp;
<b class="nc">&nbsp;		String email = jwtUtil.getUserInfoFromToken(pureToken).getSubject();</b>
<b class="nc">&nbsp;		Optional&lt;?&gt; storedTokenOpt = userTokenRepository.findByEmail(email);</b>
<b class="nc">&nbsp;		if (storedTokenOpt.isEmpty() ||</b>
<b class="nc">&nbsp;			!jwtUtil.substringToken(</b>
<b class="nc">&nbsp;					((UserToken)storedTokenOpt.get()).getRefreshToken())</b>
<b class="nc">&nbsp;				.equals(pureToken)) {</b>
<b class="nc">&nbsp;			throw new CustomException(ErrorCode.AUTH005, &quot;Refresh Token이 유효하지 않습니다.&quot;);</b>
&nbsp;		}
&nbsp;
<b class="nc">&nbsp;		String newAccessToken = jwtUtil.createAccessToken(email, UserRoleEnum.USER);</b>
<b class="nc">&nbsp;		jwtUtil.storeTokens(email, newAccessToken, pureToken);</b>
&nbsp;
<b class="nc">&nbsp;		return Map.of(&quot;accessToken&quot;, newAccessToken);</b>
&nbsp;	}
&nbsp;
&nbsp;	@Transactional(readOnly = true)
&nbsp;	public MyPageDTO getMyPage(String email) {
&nbsp;
<b class="nc">&nbsp;		User user = userRepository.findByEmailAndDeletedAtIsNull(email)</b>
<b class="nc">&nbsp;			.orElseThrow(() -&gt; new CustomException(ErrorCode.USER001, &quot;사용자를 찾을 수 없습니다.&quot;));</b>
&nbsp;
<b class="nc">&nbsp;		return new MyPageDTO(user);</b>
&nbsp;	}
&nbsp;
&nbsp;	@Transactional
&nbsp;	public UserUpdateResponseDTO updateUserInfo(UserDetailsImpl userDetails, UserUpdateRequestDTO updateRequest) {
&nbsp;
<b class="nc">&nbsp;		User user = userRepository.findByEmailAndDeletedAtIsNull(userDetails.getUsername())</b>
<b class="nc">&nbsp;			.orElseThrow(() -&gt; new CustomException(ErrorCode.USER001, &quot;사용자를 찾을 수 없습니다.&quot;));</b>
&nbsp;
<b class="nc">&nbsp;		String oldUsername = user.getUsername();</b>
&nbsp;
<b class="nc">&nbsp;		user.update(updateRequest);</b>
<b class="nc">&nbsp;		userRepository.save(user);</b>
&nbsp;
<b class="nc">&nbsp;		String newUsername = user.getUsername();</b>
<b class="nc">&nbsp;		if (!oldUsername.equals(newUsername)) {</b>
<b class="nc">&nbsp;			postRepository.updateUsernameForPosts(oldUsername, newUsername);</b>
&nbsp;		}
&nbsp;
<b class="nc">&nbsp;		String newAccessToken =</b>
<b class="nc">&nbsp;			jwtUtil.createAccessToken(</b>
<b class="nc">&nbsp;				user.getEmail(),</b>
<b class="nc">&nbsp;				user.getRole()</b>
&nbsp;			);
&nbsp;
<b class="nc">&nbsp;		String newRefreshToken</b>
<b class="nc">&nbsp;			= jwtUtil.createRefreshToken(</b>
<b class="nc">&nbsp;				user.getEmail(),</b>
<b class="nc">&nbsp;				user.getRole()</b>
&nbsp;			);
&nbsp;
<b class="nc">&nbsp;		jwtUtil.storeTokens(</b>
<b class="nc">&nbsp;			user.getEmail(),</b>
&nbsp;			newAccessToken,
&nbsp;			newRefreshToken
&nbsp;		);
&nbsp;
<b class="nc">&nbsp;		UserDTO userDTO = new UserDTO(user);</b>
<b class="nc">&nbsp;		return new UserUpdateResponseDTO(userDTO, newAccessToken);</b>
&nbsp;	}
&nbsp;
&nbsp;	@Transactional
&nbsp;	public void withdrawUser(String email) {
<b class="nc">&nbsp;		User user = userRepository.findByEmailAndDeletedAtIsNull(email)</b>
<b class="nc">&nbsp;			.orElseThrow(() -&gt; new CustomException(ErrorCode.USER001, &quot;사용자를 찾을 수 없습니다.&quot;));</b>
&nbsp;
<b class="nc">&nbsp;		if (user.getDeletedAt() != null) {</b>
<b class="nc">&nbsp;			throw new CustomException(ErrorCode.USER003, &quot;이미 탈퇴한 사용자입니다.&quot;);</b>
&nbsp;		}
&nbsp;
<b class="nc">&nbsp;		user.withdraw(user.getEmail());</b>
&nbsp;
<b class="nc">&nbsp;		userRepository.save(user);</b>
&nbsp;
<b class="nc">&nbsp;		userTokenRepository.deleteByEmail(user.getEmail());</b>
&nbsp;	}
&nbsp;
&nbsp;	@Transactional(readOnly = true)
&nbsp;	public ApiResponse findUserId(String email) {
&nbsp;
<b class="nc">&nbsp;		Optional&lt;User&gt; user = userRepository.findByEmailAndDeletedAtIsNull(email);</b>
&nbsp;
<b class="nc">&nbsp;		if (user.isPresent()) {</b>
<b class="nc">&nbsp;			return new ApiResponse(&quot;success&quot;, Map.of(&quot;email&quot;, user.get().getEmail()));</b>
&nbsp;		} else {
<b class="nc">&nbsp;			return new ApiResponse(&quot;fail&quot;, &quot;입력하신 이메일로 가입된 계정이 없습니다.&quot;);</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	@Transactional
&nbsp;	public ApiResponse findUserPassword(String email, String username) {
&nbsp;
<b class="nc">&nbsp;		Optional&lt;User&gt; user = userRepository.findByEmailAndUsernameAndDeletedAtIsNull(email, username);</b>
&nbsp;
<b class="nc">&nbsp;		if (user.isEmpty()) {</b>
<b class="nc">&nbsp;			throw new CustomException(ErrorCode.USER001, &quot;해당 이메일과 이름으로 가입된 계정이 없습니다.&quot;);</b>
&nbsp;		}
&nbsp;
<b class="nc">&nbsp;		String verificationCode = generateVerificationCode();</b>
&nbsp;
<b class="nc">&nbsp;		emailService.sendVerificationCode(email, verificationCode);</b>
&nbsp;
<b class="nc">&nbsp;		return new ApiResponse(&quot;success&quot;,</b>
<b class="nc">&nbsp;			Map.of(&quot;verificationCode&quot;, verificationCode, &quot;message&quot;, &quot;인증 코드가 이메일로 전송되었습니다.&quot;));</b>
&nbsp;	}
&nbsp;
&nbsp;	@Transactional
&nbsp;	public ApiResponse verifyCodeAndResetPassword(String email, String username, String inputCode,
&nbsp;		String verificationCode, String newPassword, String confirmPassword) {
&nbsp;
<b class="nc">&nbsp;		Optional&lt;User&gt; user = userRepository.findByEmailAndUsernameAndDeletedAtIsNull(email, username);</b>
&nbsp;
<b class="nc">&nbsp;		if (user.isEmpty()) {</b>
<b class="nc">&nbsp;			throw new CustomException(ErrorCode.USER001, &quot;해당 이메일과 이름으로 가입된 계정이 없습니다.&quot;);</b>
&nbsp;		}
&nbsp;
<b class="nc">&nbsp;		if (!inputCode.equals(verificationCode)) {</b>
<b class="nc">&nbsp;			throw new CustomException(ErrorCode.AUTH005, &quot;인증 코드가 일치하지 않습니다.&quot;);</b>
&nbsp;		}
&nbsp;
<b class="nc">&nbsp;		if (!newPassword.equals(confirmPassword)) {</b>
<b class="nc">&nbsp;			throw new CustomException(ErrorCode.AUTH006, &quot;비밀번호가 일치하지 않습니다.&quot;);</b>
&nbsp;		}
&nbsp;
<b class="nc">&nbsp;		user.get().updatePassword(passwordEncoder.encode(newPassword));</b>
<b class="nc">&nbsp;		userRepository.save(user.get());</b>
&nbsp;
<b class="nc">&nbsp;		String accessToken = jwtUtil.createAccessToken(user.get().getEmail(), user.get().getRole());</b>
<b class="nc">&nbsp;		String refreshToken = jwtUtil.createRefreshToken(user.get().getEmail(), user.get().getRole());</b>
&nbsp;
<b class="nc">&nbsp;		jwtUtil.storeTokens(user.get().getEmail(), accessToken, refreshToken);</b>
&nbsp;
<b class="nc">&nbsp;		return new ApiResponse(&quot;success&quot;, Map.of(</b>
&nbsp;			&quot;message&quot;, &quot;비밀번호가 성공적으로 변경되었습니다.&quot;,
&nbsp;			&quot;accessToken&quot;, accessToken,
&nbsp;			&quot;refreshToken&quot;, refreshToken
&nbsp;		));
&nbsp;	}
&nbsp;
&nbsp;	private String generateVerificationCode() {
&nbsp;
<b class="nc">&nbsp;		Random random = new Random();</b>
<b class="nc">&nbsp;		int code = 100000 + random.nextInt(900000);</b>
<b class="nc">&nbsp;		return String.valueOf(code);</b>
&nbsp;	}
&nbsp;
&nbsp;	@Transactional
&nbsp;	public ApiResponse addInterestLocations(String email, InterestLocationDTO interestLocationDTO) {
&nbsp;
<b class="nc">&nbsp;		User user = userRepository.findByEmailAndDeletedAtIsNull(email)</b>
<b class="nc">&nbsp;			.orElseThrow(() -&gt; new CustomException(ErrorCode.USER001, &quot;해당 사용자를 찾을 수 없습니다.&quot;));</b>
&nbsp;
<b class="nc">&nbsp;		List&lt;String&gt; interestLocations = getInterestLocations(user);</b>
&nbsp;
<b class="nc">&nbsp;		if (interestLocations.contains(interestLocationDTO)) {</b>
<b class="nc">&nbsp;			throw new CustomException(ErrorCode.LOCATION001, &quot;이미 등록된 관심 지역입니다: &quot; + interestLocationDTO);</b>
&nbsp;		}
&nbsp;
<b class="nc">&nbsp;		if (interestLocations.size() &gt;= 5) {</b>
<b class="nc">&nbsp;			throw new CustomException(ErrorCode.LOCATION002, &quot;최대 5개의 관심 지역만 등록할 수 있습니다.&quot;);</b>
&nbsp;		}
&nbsp;
<b class="nc">&nbsp;		interestLocations.add(interestLocationDTO.getLocation());</b>
&nbsp;
<b class="nc">&nbsp;		setInterestLocations(user, interestLocations);</b>
<b class="nc">&nbsp;		userRepository.save(user);</b>
&nbsp;
<b class="nc">&nbsp;		return new ApiResponse(&quot;success&quot;, &quot;관심 지역이 추가되었습니다.&quot;);</b>
&nbsp;	}
&nbsp;
&nbsp;	@Transactional
&nbsp;	public ApiResponse deleteInterestLocations(String email, List&lt;String&gt; locations) {
&nbsp;
<b class="nc">&nbsp;		User user = userRepository.findByEmailAndDeletedAtIsNull(email)</b>
<b class="nc">&nbsp;			.orElseThrow(() -&gt; new CustomException(ErrorCode.USER001, &quot;해당 사용자를 찾을 수 없습니다.&quot;));</b>
&nbsp;
<b class="nc">&nbsp;		List&lt;String&gt; interestLocations = getInterestLocations(user);</b>
&nbsp;
<b class="nc">&nbsp;		for (String location : locations) {</b>
<b class="nc">&nbsp;			if (!interestLocations.contains(location)) {</b>
<b class="nc">&nbsp;				throw new CustomException(ErrorCode.LOCATION003, &quot;등록되지 않은 관심 지역입니다: &quot; + location);</b>
&nbsp;			}
<b class="nc">&nbsp;			interestLocations.remove(location);</b>
&nbsp;		}
&nbsp;
<b class="nc">&nbsp;		setInterestLocations(user, interestLocations);</b>
<b class="nc">&nbsp;		userRepository.save(user);</b>
&nbsp;
<b class="nc">&nbsp;		return new ApiResponse(&quot;success&quot;, &quot;관심 지역이 삭제되었습니다.&quot;);</b>
&nbsp;	}
&nbsp;
&nbsp;	private List&lt;String&gt; getInterestLocations(User user) {
&nbsp;
<b class="nc">&nbsp;		return Stream.of(user.getInterestLocal1(), user.getInterestLocal2(), user.getInterestLocal3(),</b>
<b class="nc">&nbsp;				user.getInterestLocal4(), user.getInterestLocal5())</b>
<b class="nc">&nbsp;			.filter(Objects::nonNull)</b>
<b class="nc">&nbsp;			.collect(Collectors.toList());</b>
&nbsp;	}
&nbsp;
&nbsp;	private void setInterestLocations(User user, List&lt;String&gt; locations) {
&nbsp;
<b class="nc">&nbsp;		List&lt;Consumer&lt;String&gt;&gt; setters = List.of(</b>
<b class="nc">&nbsp;			user::setInterestLocal1, user::setInterestLocal2, user::setInterestLocal3,</b>
<b class="nc">&nbsp;			user::setInterestLocal4, user::setInterestLocal5</b>
&nbsp;		);
&nbsp;
<b class="nc">&nbsp;		for (int i = 0; i &lt; setters.size(); i++) {</b>
<b class="nc">&nbsp;			setters.get(i).accept(i &lt; locations.size() ? locations.get(i) : null);</b>
&nbsp;		}
&nbsp;	}
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-06-11 15:26</div>
</div>
</body>
</html>
