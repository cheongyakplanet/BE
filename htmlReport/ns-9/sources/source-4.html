


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > InfoService</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.cheonyakplanet.be.application.service</a>
</div>

<h1>Coverage Summary for Class: InfoService (org.cheonyakplanet.be.application.service)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">InfoService</td>
<td class="coverageStat">
  <span class="percent">
    13.3%
  </span>
  <span class="absValue">
    (2/15)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/44)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    1.6%
  </span>
  <span class="absValue">
    (2/122)
  </span>
</td>
</tr>
  <tr>
    <td class="name">InfoService$$SpringCGLIB$$0</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    13.3%
  </span>
  <span class="absValue">
    (2/15)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/44)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    1.6%
  </span>
  <span class="absValue">
    (2/122)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package org.cheonyakplanet.be.application.service;
&nbsp;
&nbsp;import java.io.BufferedReader;
&nbsp;import java.io.InputStreamReader;
&nbsp;import java.io.StringReader;
&nbsp;import java.math.BigDecimal;
&nbsp;import java.net.HttpURLConnection;
&nbsp;import java.net.URL;
&nbsp;import java.time.LocalDate;
&nbsp;import java.time.format.DateTimeFormatter;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Date;
&nbsp;import java.util.List;
&nbsp;import java.util.concurrent.CompletableFuture;
&nbsp;import java.util.concurrent.ExecutionException;
&nbsp;import java.util.concurrent.TimeUnit;
&nbsp;import java.util.concurrent.TimeoutException;
&nbsp;import java.util.stream.Collectors;
&nbsp;
&nbsp;import javax.xml.parsers.DocumentBuilder;
&nbsp;import javax.xml.parsers.DocumentBuilderFactory;
&nbsp;
&nbsp;import org.cheonyakplanet.be.application.dto.RealEstatePriceSummaryDTO;
&nbsp;import org.cheonyakplanet.be.domain.entity.RealEstatePrice;
&nbsp;import org.cheonyakplanet.be.domain.entity.subscription.SggCode;
&nbsp;import org.cheonyakplanet.be.domain.repository.RealEstatePriceRepository;
&nbsp;import org.cheonyakplanet.be.domain.repository.RealEstatePriceSummaryRepository;
&nbsp;import org.cheonyakplanet.be.domain.repository.SggCodeRepository;
&nbsp;import org.cheonyakplanet.be.domain.util.Utils;
&nbsp;import org.cheonyakplanet.be.presentation.exception.CustomException;
&nbsp;import org.cheonyakplanet.be.presentation.exception.ErrorCode;
&nbsp;import org.springframework.beans.factory.annotation.Qualifier;
&nbsp;import org.springframework.beans.factory.annotation.Value;
&nbsp;import org.springframework.core.task.TaskExecutor;
&nbsp;import org.springframework.retry.annotation.Backoff;
&nbsp;import org.springframework.retry.annotation.Retryable;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import org.springframework.transaction.annotation.Propagation;
&nbsp;import org.springframework.transaction.annotation.Transactional;
&nbsp;import org.w3c.dom.Document;
&nbsp;import org.w3c.dom.Node;
&nbsp;import org.w3c.dom.NodeList;
&nbsp;import org.xml.sax.InputSource;
&nbsp;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;
<b class="fc">&nbsp;@Slf4j</b>
&nbsp;@Service
<b class="fc">&nbsp;@RequiredArgsConstructor</b>
&nbsp;public class InfoService {
&nbsp;
&nbsp;	private final SggCodeRepository sggCodeRepository;
&nbsp;	private final RealEstatePriceRepository priceRepository;
&nbsp;	private final RealEstatePriceSummaryRepository priceSummaryRepository;
&nbsp;
&nbsp;	private final Utils utils;
&nbsp;
&nbsp;	@Qualifier(&quot;taskExecutor&quot;)
&nbsp;	private final TaskExecutor taskExecutor;
&nbsp;
&nbsp;	@Value(&quot;${public.api.key}&quot;)
&nbsp;	private String apiKey;
&nbsp;
&nbsp;	@Value(&quot;${realestate.api.url}&quot;)
&nbsp;	private String priceUrl;
&nbsp;
&nbsp;	public List&lt;String&gt; getReginList() {
<b class="nc">&nbsp;		List&lt;String&gt; result = sggCodeRepository.findAllRegions();</b>
&nbsp;
<b class="nc">&nbsp;		if (result.isEmpty()) {</b>
<b class="nc">&nbsp;			throw new CustomException(ErrorCode.INFO005, &quot;지역 테이블 없음 DB 확인&quot;);</b>
&nbsp;		}
<b class="nc">&nbsp;		return result;</b>
&nbsp;	}
&nbsp;
&nbsp;	public List&lt;String&gt; getCityList(String region) {
<b class="nc">&nbsp;		List&lt;String&gt; result = sggCodeRepository.findAllCities(region);</b>
&nbsp;
<b class="nc">&nbsp;		if (result.isEmpty()) {</b>
<b class="nc">&nbsp;			throw new CustomException(ErrorCode.INFO005, &quot;지역 테이블 없음 DB 확인&quot;);</b>
&nbsp;		}
<b class="nc">&nbsp;		return result;</b>
&nbsp;	}
&nbsp;
&nbsp;	@Transactional(propagation = Propagation.NOT_SUPPORTED)
&nbsp;	public void collectRealPrice(String yyyyMM) {
<b class="nc">&nbsp;		String callDate = yyyyMM;</b>
<b class="nc">&nbsp;		if (callDate == null || callDate.isEmpty()) {</b>
<b class="nc">&nbsp;			callDate = LocalDate.now().format(DateTimeFormatter.ofPattern(&quot;yyyyMM&quot;));</b>
&nbsp;		}
&nbsp;
&nbsp;		try {
&nbsp;			// 비동기 작업 실행 및 완료 대기
<b class="nc">&nbsp;			List&lt;CompletableFuture&lt;Void&gt;&gt; futures = ingestAll(callDate);</b>
&nbsp;
&nbsp;			// 모든 비동기 작업이 완료될 때까지 대기
<b class="nc">&nbsp;			CompletableFuture&lt;Void&gt; allFutures = CompletableFuture.allOf(</b>
<b class="nc">&nbsp;				futures.toArray(new CompletableFuture[0])</b>
&nbsp;			);
&nbsp;
&nbsp;			// 완료될 때까지 대기
<b class="nc">&nbsp;			allFutures.get(30, TimeUnit.MINUTES); // 최대 30분 대기</b>
&nbsp;
<b class="nc">&nbsp;			log.info(&quot;모든 데이터 수집 작업이 완료되었습니다. 이제 요약 작업을 수행합니다.&quot;);</b>
&nbsp;
&nbsp;			// 요약 작업 수행
<b class="nc">&nbsp;			refreshSummary();</b>
<b class="nc">&nbsp;		} catch (InterruptedException | ExecutionException | TimeoutException e) {</b>
<b class="nc">&nbsp;			log.error(&quot;데이터 수집 작업 대기 중 오류 발생: {}&quot;, e.getMessage(), e);</b>
<b class="nc">&nbsp;			Thread.currentThread().interrupt();</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	@Transactional(propagation = Propagation.NOT_SUPPORTED)
&nbsp;	public List&lt;CompletableFuture&lt;Void&gt;&gt; ingestAll(String callDate) {
<b class="nc">&nbsp;		List&lt;SggCode&gt; codes = sggCodeRepository.findAll();</b>
<b class="nc">&nbsp;		List&lt;CompletableFuture&lt;Void&gt;&gt; futures = new ArrayList&lt;&gt;();</b>
&nbsp;
<b class="nc">&nbsp;		for (SggCode code : codes) {</b>
<b class="nc">&nbsp;			CompletableFuture&lt;Void&gt; future = CompletableFuture.runAsync(() -&gt; {</b>
&nbsp;				try {
<b class="nc">&nbsp;					ingestOne(code, callDate);</b>
<b class="nc">&nbsp;				} catch (Exception e) {</b>
<b class="nc">&nbsp;					log.error(&quot;Ingest failed for {}: {}&quot;, code.getSggCd5(), e.getMessage(), e);</b>
&nbsp;				}
&nbsp;			}, taskExecutor);
&nbsp;
<b class="nc">&nbsp;			futures.add(future);</b>
&nbsp;		}
&nbsp;
<b class="nc">&nbsp;		return futures;</b>
&nbsp;	}
&nbsp;
&nbsp;	@Retryable(value = Exception.class, maxAttempts = 3, backoff = @Backoff(delay = 2000, multiplier = 2))
&nbsp;	@Transactional(propagation = Propagation.REQUIRES_NEW)
&nbsp;	public void ingestOne(SggCode code, String callDate) throws Exception {
&nbsp;		try {
<b class="nc">&nbsp;			String url = String.format(&quot;%s?serviceKey=%s&amp;LAWD_CD=%s&amp;DEAL_YMD=%s&amp;numOfRows=1000&quot;, priceUrl, apiKey,</b>
<b class="nc">&nbsp;				code.getSggCd5(), callDate);</b>
<b class="nc">&nbsp;			HttpURLConnection conn = null;</b>
<b class="nc">&nbsp;			StringBuilder sb = new StringBuilder();</b>
&nbsp;			try {
<b class="nc">&nbsp;				URL apiUrl = new URL(url);</b>
<b class="nc">&nbsp;				conn = (HttpURLConnection)apiUrl.openConnection();</b>
<b class="nc">&nbsp;				conn.setRequestMethod(&quot;GET&quot;);</b>
<b class="nc">&nbsp;				conn.setConnectTimeout(30000);</b>
<b class="nc">&nbsp;				conn.setReadTimeout(60000);</b>
<b class="nc">&nbsp;				int status = conn.getResponseCode();</b>
<b class="nc">&nbsp;				BufferedReader reader = new BufferedReader(</b>
<b class="nc">&nbsp;					new InputStreamReader(status == 200 ? conn.getInputStream() : conn.getErrorStream(), &quot;UTF-8&quot;));</b>
&nbsp;				String line;
<b class="nc">&nbsp;				while ((line = reader.readLine()) != null)</b>
<b class="nc">&nbsp;					sb.append(line);</b>
<b class="nc">&nbsp;				reader.close();</b>
&nbsp;			} finally {
<b class="nc">&nbsp;				if (conn != null)</b>
<b class="nc">&nbsp;					conn.disconnect();</b>
<b class="nc">&nbsp;			}</b>
<b class="nc">&nbsp;			String response = sb.toString();</b>
&nbsp;			//log.info(&quot;API 응답 (처음 500자): {}&quot;, response.length() &gt; 1000 ? response.substring(0, 1000) + &quot;...&quot; : response);
<b class="nc">&nbsp;			List&lt;RealEstatePrice&gt; list = parseResponse(response, code);</b>
<b class="nc">&nbsp;			if (list.isEmpty())</b>
<b class="nc">&nbsp;				throw new RuntimeException(&quot;No items parsed for &quot; + code.getSggCd5());</b>
<b class="nc">&nbsp;			priceRepository.saveAll(list);</b>
<b class="nc">&nbsp;			log.info(&quot;Saved {} records for {}&quot;, list.size(), code.getSggCd5());</b>
<b class="nc">&nbsp;		} catch (Exception e) {</b>
<b class="nc">&nbsp;			log.error(&quot;데이터 로드 에러 : {}&quot;, e);</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	private List&lt;RealEstatePrice&gt; parseResponse(String xml, SggCode code) throws Exception {
<b class="nc">&nbsp;		List&lt;RealEstatePrice&gt; result = new ArrayList&lt;&gt;();</b>
&nbsp;		try {
<b class="nc">&nbsp;			DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();</b>
<b class="nc">&nbsp;			DocumentBuilder builder = factory.newDocumentBuilder();</b>
<b class="nc">&nbsp;			Document doc = builder.parse(new InputSource(new StringReader(xml)));</b>
&nbsp;
<b class="nc">&nbsp;			NodeList items = doc.getElementsByTagName(&quot;item&quot;);</b>
<b class="nc">&nbsp;			log.info(&quot;발견된 item 요소 수: {}&quot;, items.getLength());</b>
&nbsp;
<b class="nc">&nbsp;			for (int i = 0; i &lt; items.getLength(); i++) {</b>
<b class="nc">&nbsp;				Node item = items.item(i);</b>
<b class="nc">&nbsp;				RealEstatePrice p = new RealEstatePrice();</b>
&nbsp;
&nbsp;				// 기본 정보 설정
<b class="nc">&nbsp;				p.setRegion(code.getSggCdNmRegion());</b>
<b class="nc">&nbsp;				p.setSggCdNm(code.getSggCdNmCity());</b>
<b class="nc">&nbsp;				p.setSggCd(String.valueOf(code.getSggCd5()));</b>
&nbsp;
&nbsp;				// 필수 데이터 추출 - null 체크 추가
<b class="nc">&nbsp;				String district = getNodeValue(item, &quot;umdNm&quot;);</b>
<b class="nc">&nbsp;				if (district != null) {</b>
<b class="nc">&nbsp;					p.setUmdNm(district);</b>
&nbsp;				} else {
<b class="nc">&nbsp;					log.warn(&quot;항목 #{}: 법정동 정보가 누락되었습니다.&quot;, i);</b>
&nbsp;				}
&nbsp;
<b class="nc">&nbsp;				p.setAptDong(getNodeValue(item, &quot;aptDong&quot;));</b>
<b class="nc">&nbsp;				p.setAptNm(getNodeValue(item, &quot;aptNm&quot;));</b>
&nbsp;
&nbsp;				// 년/월/일 처리 - null 체크 필수
<b class="nc">&nbsp;				Integer dealYear = utils.getInt(item, &quot;dealYear&quot;);</b>
<b class="nc">&nbsp;				Integer dealMonth = utils.getInt(item, &quot;dealMonth&quot;);</b>
<b class="nc">&nbsp;				Integer dealDay = utils.getInt(item, &quot;dealDay&quot;);</b>
&nbsp;
&nbsp;				// 필수 데이터가 없으면 건너뛰기
<b class="nc">&nbsp;				if (dealYear == null || dealMonth == null || dealDay == null) {</b>
<b class="nc">&nbsp;					log.warn(&quot;항목 #{}: 거래일자 정보가 누락되었습니다. year={}, month={}, day={}&quot;, i, dealYear, dealMonth, dealDay);</b>
&nbsp;					continue;
&nbsp;				}
&nbsp;
<b class="nc">&nbsp;				p.setDealYear(dealYear);</b>
<b class="nc">&nbsp;				p.setDealMonth(dealMonth);</b>
<b class="nc">&nbsp;				p.setDealDay(dealDay);</b>
&nbsp;
&nbsp;				// 거래금액 처리
<b class="nc">&nbsp;				String amt = getNodeValue(item, &quot;dealAmount&quot;);</b>
<b class="nc">&nbsp;				if (amt != null &amp;&amp; !amt.trim().isEmpty()) {</b>
&nbsp;					try {
<b class="nc">&nbsp;						p.setDealAmount(Long.parseLong(amt.replace(&quot;,&quot;, &quot;&quot;)));</b>
<b class="nc">&nbsp;					} catch (NumberFormatException e) {</b>
<b class="nc">&nbsp;						log.warn(&quot;항목 #{}: 거래금액 변환 실패: {}&quot;, i, amt);</b>
&nbsp;					}
&nbsp;				}
&nbsp;
&nbsp;				// 날짜 형식 처리 - null 체크 포함된 formatDate 메서드 사용
<b class="nc">&nbsp;				Date date = utils.formatDate(dealYear, dealMonth, dealDay);</b>
<b class="nc">&nbsp;				if (date != null) {</b>
<b class="nc">&nbsp;					p.setDealDate(date);</b>
&nbsp;				}
&nbsp;
&nbsp;				// 전용면적 처리
<b class="nc">&nbsp;				p.setExcluUseAr(utils.getBigDecimal(item, &quot;excluUseAr&quot;));</b>
&nbsp;
&nbsp;				// 모든 필수 필드가 설정되었는지 확인
<b class="nc">&nbsp;				if (p.getDealYear() != null &amp;&amp; p.getDealMonth() != null &amp;&amp; p.getDealDay() != null) {</b>
<b class="nc">&nbsp;					result.add(p);</b>
&nbsp;				} else {
<b class="nc">&nbsp;					log.warn(&quot;항목 #{}: 필수 필드가 누락되어 저장하지 않습니다.&quot;, i);</b>
&nbsp;				}
&nbsp;			}
&nbsp;
<b class="nc">&nbsp;			log.info(&quot;총 {}개의 부동산 가격 정보가 파싱되었습니다.&quot;, result.size());</b>
&nbsp;
<b class="nc">&nbsp;		} catch (Exception e) {</b>
<b class="nc">&nbsp;			log.error(&quot;XML 파싱 중 오류 발생: {}&quot;, e.getMessage(), e);</b>
<b class="nc">&nbsp;			throw e;</b>
&nbsp;		}
&nbsp;
<b class="nc">&nbsp;		return result;</b>
&nbsp;	}
&nbsp;
&nbsp;	private String getNodeValue(Node node, String tag) {
<b class="nc">&nbsp;		NodeList nl = ((org.w3c.dom.Element)node).getElementsByTagName(tag);</b>
<b class="nc">&nbsp;		if (nl.getLength() &gt; 0)</b>
<b class="nc">&nbsp;			return nl.item(0).getTextContent().trim();</b>
<b class="nc">&nbsp;		return null;</b>
&nbsp;	}
&nbsp;
&nbsp;	public List&lt;RealEstatePriceSummaryDTO&gt; getRealEstateSummaryDong(String region, String city, String umdNm) {
&nbsp;
<b class="nc">&nbsp;		List&lt;Object[]&gt; results = priceSummaryRepository.findByRegionAndSggCdNmAndUmdNm(region, city, umdNm);</b>
&nbsp;
<b class="nc">&nbsp;		return results.stream()</b>
<b class="nc">&nbsp;			.map(row -&gt; RealEstatePriceSummaryDTO.builder()</b>
&nbsp;				//.region((String)row[0])
&nbsp;				//.sggCdNm((String)row[1])
&nbsp;				//.umdNm((String)row[2])
<b class="nc">&nbsp;				.dealYearMonth(((Integer)row[3]) * 100 + ((Integer)row[4]))</b>
&nbsp;				// .dealMonth((Integer)row[4])
<b class="nc">&nbsp;				.dealCount((Integer)row[5])</b>
<b class="nc">&nbsp;				.pricePerAr((Long)row[6])</b>
<b class="nc">&nbsp;				.build())</b>
<b class="nc">&nbsp;			.collect(Collectors.toList());</b>
&nbsp;	}
&nbsp;
&nbsp;	public List&lt;RealEstatePriceSummaryDTO&gt; getRealEstateSummaryGu(String region, String city) {
&nbsp;
<b class="nc">&nbsp;		List&lt;Object[]&gt; results = priceSummaryRepository.findByRegionAndSggCdNm(region, city);</b>
&nbsp;
<b class="nc">&nbsp;		return results.stream()</b>
<b class="nc">&nbsp;			.map(row -&gt; RealEstatePriceSummaryDTO.builder()</b>
<b class="nc">&nbsp;				.dealYearMonth(((Number)row[2]).intValue() * 100 + ((Number)row[3]).intValue())</b>
<b class="nc">&nbsp;				.dealCount(((BigDecimal)row[4]).intValue())</b>
<b class="nc">&nbsp;				.pricePerAr(((BigDecimal)row[5]).longValue())</b>
<b class="nc">&nbsp;				.build())</b>
<b class="nc">&nbsp;			.collect(Collectors.toList());</b>
&nbsp;	}
&nbsp;
&nbsp;	@Transactional
&nbsp;	public void refreshSummary() {
<b class="nc">&nbsp;		priceSummaryRepository.deleteAll();</b>
<b class="nc">&nbsp;		priceSummaryRepository.insertSummary(); //TODO : 생성마다 모든 데이터 요약되는거 수정!!</b>
&nbsp;	}
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-06-11 15:26</div>
</div>
</body>
</html>
