


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > CommunityService</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.cheonyakplanet.be.application.service</a>
</div>

<h1>Coverage Summary for Class: CommunityService (org.cheonyakplanet.be.application.service)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">CommunityService</td>
<td class="coverageStat">
  <span class="percent">
    6.7%
  </span>
  <span class="absValue">
    (1/15)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/22)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    1%
  </span>
  <span class="absValue">
    (1/102)
  </span>
</td>
</tr>
  <tr>
    <td class="name">CommunityService$$SpringCGLIB$$0</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    6.7%
  </span>
  <span class="absValue">
    (1/15)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/22)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    1%
  </span>
  <span class="absValue">
    (1/102)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package org.cheonyakplanet.be.application.service;
&nbsp;
&nbsp;import java.util.List;
&nbsp;import java.util.Optional;
&nbsp;
&nbsp;import org.cheonyakplanet.be.application.dto.community.CommentDTO;
&nbsp;import org.cheonyakplanet.be.application.dto.community.PostCreateDTO;
&nbsp;import org.cheonyakplanet.be.application.dto.community.PostDTO;
&nbsp;import org.cheonyakplanet.be.application.dto.community.PostDetailDTO;
&nbsp;import org.cheonyakplanet.be.application.dto.community.PostUpdateRequestDTO;
&nbsp;import org.cheonyakplanet.be.domain.entity.comunity.Comment;
&nbsp;import org.cheonyakplanet.be.domain.entity.comunity.Post;
&nbsp;import org.cheonyakplanet.be.domain.entity.comunity.PostCategory;
&nbsp;import org.cheonyakplanet.be.domain.entity.comunity.PostReaction;
&nbsp;import org.cheonyakplanet.be.domain.entity.comunity.ReactionType;
&nbsp;import org.cheonyakplanet.be.domain.entity.comunity.Reply;
&nbsp;import org.cheonyakplanet.be.domain.entity.user.User;
&nbsp;import org.cheonyakplanet.be.domain.repository.CommentRepository;
&nbsp;import org.cheonyakplanet.be.domain.repository.PostReactionRepository;
&nbsp;import org.cheonyakplanet.be.domain.repository.PostRepository;
&nbsp;import org.cheonyakplanet.be.domain.repository.ReplyRepository;
&nbsp;import org.cheonyakplanet.be.infrastructure.security.UserDetailsImpl;
&nbsp;import org.cheonyakplanet.be.presentation.exception.CustomException;
&nbsp;import org.cheonyakplanet.be.presentation.exception.ErrorCode;
&nbsp;import org.springframework.data.domain.Page;
&nbsp;import org.springframework.data.domain.PageRequest;
&nbsp;import org.springframework.data.domain.Pageable;
&nbsp;import org.springframework.data.domain.Sort;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import org.springframework.transaction.annotation.Transactional;
&nbsp;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;
&nbsp;@Service
<b class="fc">&nbsp;@RequiredArgsConstructor</b>
&nbsp;public class CommunityService {
&nbsp;
&nbsp;	private final PostRepository postRepository;
&nbsp;	private final CommentRepository commentRepository;
&nbsp;	private final ReplyRepository replyRepository;
&nbsp;	private final PostReactionRepository reactionRepository;
&nbsp;
&nbsp;	public Post createPost(PostCreateDTO postCreateDTO, UserDetailsImpl userDetails) {
&nbsp;
<b class="nc">&nbsp;		User user = userDetails.getUser();</b>
&nbsp;
<b class="nc">&nbsp;		Post post = Post.builder()</b>
<b class="nc">&nbsp;			.username(user.getUsername())</b>
<b class="nc">&nbsp;			.title(postCreateDTO.getTitle())</b>
<b class="nc">&nbsp;			.content(postCreateDTO.getContent())</b>
<b class="nc">&nbsp;			.category(PostCategory.valueOf(postCreateDTO.getPostCategory()))</b>
<b class="nc">&nbsp;			.likes(0)</b>
<b class="nc">&nbsp;			.build();</b>
&nbsp;
<b class="nc">&nbsp;		postRepository.save(post);</b>
<b class="nc">&nbsp;		return post;</b>
&nbsp;	}
&nbsp;
&nbsp;	public void deletePost(Long postId, UserDetailsImpl userDetails) {
<b class="nc">&nbsp;		User user = userDetails.getUser();</b>
&nbsp;
&nbsp;		// 삭제할 게시글 조회 (존재하지 않으면 예외 발생)
<b class="nc">&nbsp;		Post post = postRepository.findById(postId)</b>
<b class="nc">&nbsp;			.orElseThrow(() -&gt; new CustomException(ErrorCode.COMU001, &quot;해당 게시글이 존재하지 않습니다.&quot;));</b>
&nbsp;
&nbsp;		// 게시글 작성자와 요청 사용자의 username이 일치하는지 확인
<b class="nc">&nbsp;		if (!post.getUsername().equals(user.getUsername())) {</b>
<b class="nc">&nbsp;			throw new CustomException(ErrorCode.COMU002, &quot;게시글 삭제 권한이 없습니다.&quot;);</b>
&nbsp;		}
<b class="nc">&nbsp;		post.setDeletedBy(user.getUsername());</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * 게시글 전체 조회 기능 (정렬 기준: time, views, likes, 페이징 포함)
&nbsp;	 *
&nbsp;	 * @param sort 정렬 기준 (time, views, likes)
&nbsp;	 * @param page 페이지 번호 (0부터 시작)
&nbsp;	 * @param size 페이지 당 항목 수
&nbsp;	 * @return 페이징 처리된 PostDTO Page 객체
&nbsp;	 */
&nbsp;	public Page&lt;PostDTO&gt; getAllPosts(String sort, int page, int size) {
&nbsp;		Sort sortOrder;
<b class="nc">&nbsp;		if (&quot;likes&quot;.equalsIgnoreCase(sort)) {</b>
<b class="nc">&nbsp;			sortOrder = Sort.by(&quot;likes&quot;).descending();</b>
<b class="nc">&nbsp;		} else if (&quot;views&quot;.equalsIgnoreCase(sort)) {</b>
<b class="nc">&nbsp;			sortOrder = Sort.by(Sort.Direction.DESC, &quot;views&quot;);</b>
&nbsp;		} else {
<b class="nc">&nbsp;			sortOrder = Sort.by(Sort.Direction.DESC, &quot;createdAt&quot;);</b>
&nbsp;		}
&nbsp;
<b class="nc">&nbsp;		Pageable pageable = PageRequest.of(page, size, sortOrder);</b>
&nbsp;
<b class="nc">&nbsp;		Page&lt;Post&gt; postPage = postRepository.findAllByDeletedAtIsNullAndIsBlindIsFalse(pageable);</b>
&nbsp;
<b class="nc">&nbsp;		return postPage.map(Post::ToDTO);</b>
&nbsp;	}
&nbsp;
&nbsp;	@Transactional
&nbsp;	public PostDetailDTO getPostById(Long id, UserDetailsImpl userDetails) {
&nbsp;		try {
<b class="nc">&nbsp;			Post post = postRepository.findPostByIdAndDeletedAtIsNull(id);</b>
<b class="nc">&nbsp;			post.countViews();</b>
&nbsp;
<b class="nc">&nbsp;			String email = userDetails.getUsername();</b>
<b class="nc">&nbsp;			PostReaction myReaction = reactionRepository</b>
<b class="nc">&nbsp;				.findByPostAndEmail(post, email)</b>
<b class="nc">&nbsp;				.orElse(null);</b>
&nbsp;
<b class="nc">&nbsp;			return PostDetailDTO.fromEntity(post, myReaction);</b>
&nbsp;
<b class="nc">&nbsp;		} catch (Exception e) {</b>
<b class="nc">&nbsp;			throw new CustomException(ErrorCode.COMU001, e.getMessage());</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	public List&lt;Post&gt; getPopularPosts() {
<b class="nc">&nbsp;		return postRepository.findPostsOrderByLikesAndDeletedAtIsNull(PageRequest.of(0, 5)); // 상위 5개</b>
&nbsp;	}
&nbsp;
&nbsp;	public Page&lt;PostDTO&gt; getMyPosts(String sort, int page, int size, UserDetailsImpl userDetails) {
&nbsp;		Sort sortOrder;
<b class="nc">&nbsp;		if (&quot;likes&quot;.equalsIgnoreCase(sort)) {</b>
<b class="nc">&nbsp;			sortOrder = Sort.by(&quot;likes&quot;).descending();</b>
<b class="nc">&nbsp;		} else if (&quot;views&quot;.equalsIgnoreCase(sort)) {</b>
<b class="nc">&nbsp;			sortOrder = Sort.by(Sort.Direction.DESC, &quot;views&quot;);</b>
&nbsp;		} else {
<b class="nc">&nbsp;			sortOrder = Sort.by(Sort.Direction.DESC, &quot;createdAt&quot;);</b>
&nbsp;		}
&nbsp;
<b class="nc">&nbsp;		Pageable pageable = PageRequest.of(page, size, sortOrder);</b>
&nbsp;
&nbsp;		// 현재 로그인한 사용자의 username으로 필터링
<b class="nc">&nbsp;		String username = userDetails.getUser().getUsername();</b>
<b class="nc">&nbsp;		Page&lt;Post&gt; postPage = postRepository.findByUsernameAndDeletedAtIsNullAndBlindIsFalse(username, pageable);</b>
&nbsp;
<b class="nc">&nbsp;		return postPage.map(Post::ToDTO);</b>
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * 게시글 좋아요
&nbsp;	 *
&nbsp;	 * @param id
&nbsp;	 */
&nbsp;	@Transactional
&nbsp;	public void likePost(Long id, UserDetailsImpl userDetails) {
<b class="nc">&nbsp;		Post post = postRepository.findPostByIdAndDeletedAtIsNull(id);</b>
<b class="nc">&nbsp;		String email = userDetails.getUsername();</b>
<b class="nc">&nbsp;		Optional&lt;PostReaction&gt; existingReaction = reactionRepository.findByPostAndEmail(post, email);</b>
&nbsp;
<b class="nc">&nbsp;		if (existingReaction.isPresent()) {</b>
<b class="nc">&nbsp;			throw new CustomException(ErrorCode.COMU003, &quot;이미 반응하였습니다.&quot;);</b>
&nbsp;		}
&nbsp;
&nbsp;		// 좋아요 여부 기록
<b class="nc">&nbsp;		PostReaction reaction = PostReaction.builder()</b>
<b class="nc">&nbsp;			.post(post)</b>
<b class="nc">&nbsp;			.email(email)</b>
<b class="nc">&nbsp;			.reactionType(ReactionType.LIKE)</b>
<b class="nc">&nbsp;			.build();</b>
<b class="nc">&nbsp;		reactionRepository.save(reaction);</b>
&nbsp;
<b class="nc">&nbsp;		post.incrementLikes();</b>
<b class="nc">&nbsp;		postRepository.save(post);</b>
&nbsp;	}
&nbsp;
&nbsp;	public void dislikePost(Long id, UserDetailsImpl userDetails) {
<b class="nc">&nbsp;		Post post = postRepository.findPostByIdAndDeletedAtIsNull(id);</b>
<b class="nc">&nbsp;		String email = userDetails.getUsername();</b>
<b class="nc">&nbsp;		Optional&lt;PostReaction&gt; existingReaction = reactionRepository.findByPostAndEmail(post, email);</b>
&nbsp;
<b class="nc">&nbsp;		if (existingReaction.isPresent()) {</b>
<b class="nc">&nbsp;			throw new CustomException(ErrorCode.COMU003, &quot;이미 반응하였습니다.&quot;);</b>
&nbsp;		}
&nbsp;
<b class="nc">&nbsp;		PostReaction reaction = PostReaction.builder()</b>
<b class="nc">&nbsp;			.post(post)</b>
<b class="nc">&nbsp;			.email(email)</b>
<b class="nc">&nbsp;			.reactionType(ReactionType.DISLIKE)</b>
<b class="nc">&nbsp;			.build();</b>
<b class="nc">&nbsp;		reactionRepository.save(reaction);</b>
<b class="nc">&nbsp;		post.increaseDislikes();</b>
<b class="nc">&nbsp;		postRepository.save(post);</b>
&nbsp;	}
&nbsp;
&nbsp;	public void addComment(Long postId, CommentDTO commentDTO, UserDetailsImpl userDetails) {
<b class="nc">&nbsp;		Post post = postRepository.findPostByIdAndDeletedAtIsNull(postId);</b>
<b class="nc">&nbsp;		User user = userDetails.getUser();</b>
<b class="nc">&nbsp;		Comment comment = Comment.builder()</b>
<b class="nc">&nbsp;			.content(commentDTO.getContent())</b>
<b class="nc">&nbsp;			.username(user.getUsername())</b>
<b class="nc">&nbsp;			.post(post)</b>
<b class="nc">&nbsp;			.build();</b>
<b class="nc">&nbsp;		commentRepository.save(comment);</b>
&nbsp;	}
&nbsp;
&nbsp;	public List&lt;Comment&gt; getCommentsByPostId(Long postId) {
<b class="nc">&nbsp;		Post post = postRepository.findPostByIdAndDeletedAtIsNull(postId);</b>
<b class="nc">&nbsp;		return post.getComments();</b>
&nbsp;	}
&nbsp;
&nbsp;	public Comment getCommentById(Long commentId) {
<b class="nc">&nbsp;		return commentRepository.findById(commentId)</b>
<b class="nc">&nbsp;			.orElseThrow(() -&gt; new RuntimeException(&quot;Comment not found&quot;));</b>
&nbsp;	}
&nbsp;
&nbsp;	public Reply addReply(Long commentId, CommentDTO commentDTO, UserDetailsImpl userDetails) {
<b class="nc">&nbsp;		Comment comment = getCommentById(commentId);</b>
<b class="nc">&nbsp;		User user = userDetails.getUser();</b>
<b class="nc">&nbsp;		Reply reply = Reply.builder()</b>
<b class="nc">&nbsp;			.content(commentDTO.getContent())</b>
<b class="nc">&nbsp;			.comment(comment)</b>
<b class="nc">&nbsp;			.username(user.getUsername())</b>
<b class="nc">&nbsp;			.build();</b>
<b class="nc">&nbsp;		return replyRepository.save(reply);</b>
&nbsp;	}
&nbsp;
&nbsp;	@Transactional
&nbsp;	public PostDTO updatePost(Long postId,
&nbsp;		PostUpdateRequestDTO request,
&nbsp;		UserDetailsImpl userDetails) {
&nbsp;
<b class="nc">&nbsp;		Post post = postRepository</b>
<b class="nc">&nbsp;			.findByIdAndDeletedAtIsNullAndBlindIsFalse(postId)</b>
<b class="nc">&nbsp;			.orElseThrow(() -&gt;</b>
<b class="nc">&nbsp;				new CustomException(ErrorCode.COMU001, &quot;게시글이 존재하지 않습니다.&quot;)</b>
&nbsp;			);
&nbsp;
<b class="nc">&nbsp;		String currentUsername = userDetails.getUser().getUsername();</b>
<b class="nc">&nbsp;		if (!post.getUsername().equals(currentUsername)) {</b>
<b class="nc">&nbsp;			throw new CustomException(</b>
&nbsp;				ErrorCode.COMU002,
&nbsp;				&quot;작성한 게시글만 수정 가능합니다.&quot;
&nbsp;			);
&nbsp;		}
&nbsp;
<b class="nc">&nbsp;		String newTitle = request.title() != null ? request.title() : post.getTitle();</b>
<b class="nc">&nbsp;		String newContent = request.content() != null ? request.content() : post.getContent();</b>
<b class="nc">&nbsp;		PostCategory newCategory = request.category() != null ? request.category() : post.getCategory();</b>
&nbsp;
<b class="nc">&nbsp;		post.updateContent(newTitle, newContent, newCategory);</b>
&nbsp;
<b class="nc">&nbsp;		return Post.ToDTO(post);</b>
&nbsp;	}
&nbsp;
&nbsp;	// TODO : 작성자 별칭 등록및 보이는 기능 추가
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-06-11 15:26</div>
</div>
</body>
</html>
